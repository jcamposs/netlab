<%= javascript_tag do %>

  function clearScene() {
    var widget = <%= @module %>.getWidget();
    var nodes = widget.getNodes();

    for(var i = 0; i < nodes.length; i++)
      widget.removeNode(nodes[i].name);
  };

  function loadStage(json) {
    if (!json)
      return;

    var widget = <%= @module %>.getWidget();
    Netlab.loadJSON(widget, json);
  };

  function loadJSON(sceneId)
  {
    $.ajax({
      url: '/scenes/' + sceneId + '?redirect_url=' + window.location.protocol + '//' + window.location.host + '/workspaces',
      dataType: 'json',
      success: function(data) {
        if(data.redirect)
          window.location.href = data.redirect; 
        else
          loadStage(data.definition);
      }
    })
  };

  function initJSON() {
    var sceneId = $('#workspace_scene_id').val();

    if (sceneId >= 0)
      loadJSON(sceneId);
  };

  function initWidget() {
    $("#workspace_scene_id").change(function() {
        clearScene();
        loadJSON($('#workspace_scene_id').val());
    });

    <%= @module %>.initWidget({
      container: "container",
      width: <%= @width %>,
      height: <%= @height %>,
      mode: "<%= @mode %>",
      callback: initJSON
    });
  };

  $(window).load( function() {
    initWidget();
  });

<% end %>
